<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <div id="map" style="height: 600px; width: 100%"></div>

    <script>
      const displayOptions = {
        fillColor: '#206f6a',
        fillOpacity: 0.65,
        strokeColor: '#104f50',
        strokeOpacity: 0.9,
        strokeWeight: 4,
      };

      function displayWKTPolygon(map) {
        // Get the WKT string from the input field
        // const input = document.querySelector('input[name="{{ widget.name }}"]');
        // const wktString = input.value.trim().replace(" ", "");
        // hardcoded input
        const wktString =
          'SRID=4326;POLYGON((13.40 52.52, 13.41 52.52, 13.41 52.53, 13.40 52.53, 13.40 52.52))';

        // Check that the WKT string is valid
        if (!wktString.startsWith('SRID=4326;POLYGON((')) {
          console.log(wktString);
          console.error('Invalid WKT format');
          return;
        }

        // Extract the coordinates part from the WKT string
        const coordsText = wktString
          .replace('SRID=4326;POLYGON((', '')
          .replace('))', '')
          .trim();

        // Parse the coordinates into an array of google.maps.LatLng objects
        const coordinates = coordsText.split(',').map((coord) => {
          const [lng, lat] = coord.trim().split(' ').map(Number);
          return new google.maps.LatLng(lat, lng);
        });

        // Create and display the polygon on the map
        const defaultOptions = {
          paths: coordinates,
          map: map,
        };
        const polygon = new google.maps.Polygon({
          ...defaultOptions,
          ...displayOptions,
        });

        // Adjust map view to fit the polygon bounds
        const bounds = new google.maps.LatLngBounds();
        coordinates.forEach((coord) => bounds.extend(coord));
        map.fitBounds(bounds);
      }

      function asCoord(vertice) {
        return `${vertice.lng()} ${vertice.lat()}`;
      }

      let map;
      let marker;
      let geocoder;
      let responseDiv;
      let response;

      // https://developers.google.com/maps/documentation/javascript/reference/map?hl=de
      function initMap() {
        const LOCATION = { lat: 52.52, lng: 13.4 };

        // https://developers.google.com/maps/documentation/javascript/style-reference
        const customMapStyle = [
          {
            featureType: 'poi',
            stylers: [{ visibility: 'off' }],
          },
          {
            featureType: 'landscape',
            elementType: 'labels',
            stylers: [{ visibility: 'off' }],
          },
          {
            featureType: 'transit.station',
            stylers: [{ visibility: 'off' }],
          },
        ];

        map = new google.maps.Map(document.getElementById('map'), {
          center: LOCATION, // TODO get this from django
          zoom: 13, // TODO get this from django
          mapTypeId: 'hybrid',
          streetViewControl: false,
          mapTypeControl: false,
          panControl: false,
          rotateControl: false,
          styles: customMapStyle,
        });

        // https://developers.google.com/maps/documentation/javascript/drawinglayer?hl=de
        const drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYGON,
          drawingControl: false,
          polygonOptions: displayOptions,
        });

        // TODO Display edges of polygon as feature points

        // TODO prevent mousemove-event for navigation when drawing manager is active (click event is prevented by default)

        drawingManager.setMap(map);

        google.maps.event.addListener(
          drawingManager,
          'polygoncomplete',
          function (poly) {
            // var area = google.maps.geometry.spherical.computeArea(poly.getPath())

            let vertices = poly.getPath();
            let coords = asCoord(vertices.getAt(0));
            for (let i = 1; i < vertices.getLength(); i++) {
              coords += `,${asCoord(vertices.getAt(i))}`;
            }
            coords += `,${asCoord(vertices.getAt(0))}`;

            wktstr = `SRID=4326;POLYGON( ( ${coords} ) )`;

            const input = document.querySelector(
              'input[name="{{ widget.name }}"]'
            );
            input.value = wktstr;
          }
        );

        // --------------------------
        // Geocoding
        // --------------------------
        geocoder = new google.maps.Geocoder();

        const wrapper = document.createElement('div');
        wrapper.classList.add('grid', 'grid-flex', 'bg-white', 'p-4');

        const inputText = document.createElement('input');
        inputText.classList.add(
          'mt-1',
          'block',
          'w-full',
          'px-3',
          'py-2',
          'bg-white',
          'border',
          'border-slate-300',
          'rounded-md',
          'text-sm',
          'shadow-sm',
          'placeholder-slate-400'
        );

        inputText.type = 'text';
        inputText.placeholder = 'Adresse eingeben ...';

        const submitButton = document.createElement('input');

        submitButton.type = 'button';
        submitButton.value = 'Suchen';
        submitButton.classList.add(
          'font-medium',
          'ag-bg',
          'bg-agrario-primary',
          'text-white',
          'px-4',
          'py-2',
          'rounded-md',
          'hover:bg-opacity-80'
        );

        const clearButton = document.createElement('input');

        clearButton.type = 'button';
        clearButton.value = 'Clear';
        clearButton.classList.add(
          'font-medium',
          'ag-bg',
          'bg-agrario-primary',
          'text-white',
          'px-4',
          'py-2',
          'rounded-md',
          'hover:bg-opacity-80'
        );

        //response = document.createElement("pre");
        //response.id = "response";
        //response.innerText = "";
        //responseDiv = document.createElement("div");
        //responseDiv.id = "response-container";
        //responseDiv.appendChild(response);

        const instructionsElement = document.createElement('p');

        instructionsElement.id = 'instructions';
        instructionsElement.classList.add('bg-white', 'p-4');
        instructionsElement.innerHTML =
          '<strong>Anleitung</strong>: Eingabe einer Adresse in der Textbox um zu ihr zu springen.';

        const buttonRow = document.createElement('div');
        buttonRow.classList.add('row', 'p-2');
        buttonRow.appendChild(submitButton);
        buttonRow.appendChild(clearButton);

        wrapper.appendChild(instructionsElement);
        wrapper.appendChild(inputText);
        wrapper.appendChild(buttonRow);

        // map.controls[google.maps.ControlPosition.LEFT_TOP].push(wrapper);

        marker = new google.maps.Marker({
          map,
        });
        submitButton.addEventListener('click', () =>
          geocode({ address: inputText.value })
        );
        inputText.addEventListener('keydown', (e) => {
          console.log(e.key);
          if (e.key === 'Enter') {
            e.preventDefault();
            geocode({ address: inputText.value });
          }
        });
        clearButton.addEventListener('click', () => {
          clear();
        });
        clear();

        displayWKTPolygon(map);
      }

      function clear() {
        marker.setMap(null);
        //responseDiv.style.display = "none";
      }

      function geocode(request) {
        clear();
        geocoder
          .geocode(request)
          .then((result) => {
            const { results } = result;

            map.setCenter(results[0].geometry.location);
            map.setZoom(16);
            marker.setPosition(results[0].geometry.location);
            marker.setMap(map);
            //responseDiv.style.display = "block";
            //response.innerText = JSON.stringify(result, null, 2);
            return results;
          })
          .catch((e) => {
            alert('Geocode was not successful for the following reason: ' + e);
          });
      }
      window.initMap = initMap;
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=VITE_GOOGLE_KEY&callback=initMap&v=weekly&libraries=drawing,geometry"
      defer
    ></script>
  </body>
</html>
